<!DOCTYPE html>
<html lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="UTF-8">

    

    

    <title>Category: SpringCloud | 我喜欢你喜欢我的歌</title>
    <meta name="author" content="Dick Zhong">
    <meta name="version" content="1.0.0">
    <meta name="keywords" content>
    <meta name="description" content>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">

    
    <link rel="alternate" href="/atom.xml" title="我喜欢你喜欢我的歌" type="application/atom+xml">
    
    
    <link rel="icon" href="/images/favicon.ico">
    

    <link rel="stylesheet" href="/css/style.css">
</head>
<body>

    <main class="app">
        <header class="header clearfix">
    <div id="nav" class="nav">
    <div class="nav-mobile">
        <button id="open-panel" class="open-panel nav-mobile-item"><i class="icon-documents"></i></button>
        <h1 class="nav-mobile-title nav-mobile-item">我喜欢你喜欢我的歌</h1>
        <button id="open-menus" class="open-panel nav-mobile-item"><i class="icon-library"></i></button>
    </div>

    <nav id="nav-inner" class="nav-inner">
        
            <a class="nav-item" href="/">
                <span class="nav-text">首页</span>
            </a>
        
            <a class="nav-item active" href="/categories/">
                <span class="nav-text">分类</span>
            </a>
        
            <a class="nav-item" href="/tags">
                <span class="nav-text">标签</span>
            </a>
        
            <a class="nav-item" href="/archives">
                <span class="nav-text">归档</span>
            </a>
        
            <a class="nav-item" href="/atom.xml">
                <span class="nav-text">订阅</span>
            </a>
        
            <a class="nav-item" href="/about">
                <span class="nav-text">关于</span>
            </a>
        
    </nav>
</div>

    <aside id="aside" class="aside">
    <div id="aside-mask" class="aside-mask"></div>
    <div id="aside-inner" class="aside-inner">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit"><i class="icon-search-stroke"></i></button><input type="hidden" name="sitesearch" value="https://wxzhongwang.github.io"></form>

        
        

        
        <div class="author-meta">
            
            <div class="author-avatar">
                <a href="/">
                    <img src="/images/27359059.jpg" title="咸鱼有点咸">
                </a>
            </div>
            
            <div class="author-name">咸鱼有点咸</div>
            <div class="author-work">Developer</div>
            <div class="author-location">
                <i class="icon-location vm"></i>
                <span class="vm">Hangzhou, China</span>
            </div>
            
            <div class="author-thread-wrap">
                <div class="author-threads clearfix">
                    
                        <a class="thread-item" href="https://github.com/wxzhongwang" target="_blank" rel="noopener">
                            <!-- Generated by IcoMoon.io -->
<svg viewbox="0 0 1024 1024" width="38" height="38" fill="currentColor">
<path d="M512 32.12c-265.004 0-479.88 220.23-479.88 492.090 0 217.446 137.536 401.684 328.202 466.81 23.994 4.498 32.778-10.712 32.778-23.78 0-11.782-0.428-42.632-0.642-83.764-133.466 29.778-161.744-65.984-161.744-65.984-21.852-56.772-53.344-71.982-53.344-71.982-43.49-30.636 3.214-29.992 3.214-29.992 48.202 3.428 73.482 50.772 73.482 50.772 42.846 75.196 112.258 53.558 139.68 40.918 4.284-31.706 16.71-53.558 30.42-65.77-106.474-12.426-218.516-54.63-218.516-243.152 0-53.772 18.638-97.69 49.274-131.966-4.928-12.426-21.424-62.556 4.714-130.252 0 0 40.276-13.282 131.966 50.344 38.348-10.926 79.266-16.282 120.184-16.496 40.704 0.214 81.836 5.57 120.184 16.496 91.692-63.626 131.752-50.344 131.752-50.344 26.136 67.698 9.64 117.828 4.714 130.252 30.636 34.492 49.274 78.408 49.274 131.966 0 188.952-112.258 230.514-219.16 242.724 17.138 15.21 32.564 45.202 32.564 91.048 0 65.77-0.642 118.898-0.642 134.966 0 13.068 8.57 28.492 32.992 23.566 191.094-64.912 328.418-249.152 328.418-466.382 0-271.86-214.874-492.090-479.88-492.090z"/>
</svg>

                        </a>
                    
                        <a class="thread-item" href="https://weibo.com/u/6558527999" target="_blank" rel="noopener">
                            <!-- Generated by IcoMoon.io -->
<svg viewbox="0 0 1024 1024" width="38" height="38" fill="currentColor">
<path d="M21.332 512c0-270.988 219.68-490.666 490.668-490.666s490.666 219.68 490.666 490.666c0 270.988-219.678 490.666-490.666 490.666s-490.666-219.678-490.666-490.666zM960 512c0-247.424-200.576-448-448-448s-448 200.576-448 448c0 247.424 200.576 448 448 448s448-200.576 448-448zM768 597.332c47.128 0 85.332-38.206 85.332-85.332s-38.206-85.332-85.332-85.332c-47.128 0-85.332 38.204-85.332 85.332s38.206 85.332 85.332 85.332zM512 597.332c47.128 0 85.332-38.206 85.332-85.332s-38.206-85.332-85.332-85.332c-47.128 0-85.332 38.204-85.332 85.332s38.204 85.332 85.332 85.332zM255.998 597.332c47.128 0 85.332-38.206 85.332-85.332s-38.204-85.332-85.332-85.332c-47.128 0-85.332 38.204-85.332 85.332s38.204 85.332 85.332 85.332z"/>
</svg>

                        </a>
                    
                        <a class="thread-item" href="https://twitter.com/wxzhongwang" target="_blank" rel="noopener">
                            <!-- Generated by IcoMoon.io -->
<svg viewbox="0 0 1024 1024" width="38" height="38" fill="currentColor">
<path d="M512.029 31.011c-263.32 0-476.784 213.502-476.784 476.784 0 263.32 213.464 476.743 476.784 476.743s476.743-213.424 476.743-476.743c0-263.282-213.444-476.784-476.743-476.784zM752.193 411.663c0.251 5.151 0.349 10.319 0.349 15.548 0 158.786-120.856 341.85-341.85 341.85-67.844 0-131.021-19.884-184.188-53.961 9.41 1.104 18.955 1.665 28.656 1.665 56.305 0 108.115-19.208 149.221-51.425-52.567-0.987-96.925-35.741-112.22-83.468 7.32 1.433 14.85 2.149 22.595 2.149 10.959 0 21.569-1.433 31.656-4.201-54.987-11.035-96.402-59.634-96.402-117.796 0-0.524 0-1.025 0.020-1.549 16.186 9.003 34.716 14.404 54.427 15.044-32.258-21.587-53.458-58.317-53.458-100.023 0-22.015 5.925-42.673 16.264-60.408 59.266 72.683 147.807 120.527 247.676 125.521-2.053-8.77-3.118-17.968-3.118-27.378 0-66.333 53.787-120.14 120.158-120.14 34.561 0 65.771 14.599 87.69 37.93 27.378-5.363 53.091-15.393 76.305-29.16-9.003 28.074-28.036 51.618-52.858 66.47 24.338-2.903 47.495-9.37 69.024-18.917-16.070 24.144-36.459 45.306-59.945 62.248z"/>
</svg>

                        </a>
                    
                </div>
            </div>
            
        </div>
        
    </div>
</aside>

</header>

        <div id="content" class="content">
    <article class="article" itemscope itemprop="blogPost">
    
    <header class="article-header">
        
        <h1 itemprop="name">
            <a href="/2019/12/02/Skywalking 分布式链路追踪 /">Skywalking 分布式链路追踪</a>
        </h1>
        
        <div class="article-meta clearfix">
            <a class="article-date" href="https://wxzhongwang.github.io/categories/SpringCloud/index.html">
    
    <i class="icon-calendar"></i>
    
    <time datetime="2019-12-02T04:30:00.000Z" itemprop="datePublished">2019-12-02</time>
</a>

            
<div class="article-tag-list">
    <i class="icon-tag"></i>
    <a class="article-tag-link" href="/tags/SpringCloud/">SpringCloud</a>
</div>


        </div>
    </header>
    
    <section class="article-body markdown-body">
        
        <h1 id="Skywalking-分布式链路追踪"><a href="#Skywalking-分布式链路追踪" class="headerlink" title="Skywalking 分布式链路追踪"></a>Skywalking 分布式链路追踪</h1><h2 id="skywalking下载"><a href="#skywalking下载" class="headerlink" title="skywalking下载"></a>skywalking下载</h2><p>在官网下载最新版skywalking：<br>• <a href="http://skywalking.apache.org/downloads/" target="_blank" rel="noopener">下载地址</a></p>
<p><a href="http://skywalking.apache.org/downloads/" target="_blank" rel="noopener">http://skywalking.apache.org/downloads/</a></p>
<h2 id="解压后启动"><a href="#解压后启动" class="headerlink" title="解压后启动"></a>解压后启动</h2><p>启动skywalking后台程序和ui<br>在此之前可以修改ui等启动的端口。</p>
<blockquote>
<p>例如ui的端口，在webapp目录下–&gt;的webapp.yml文件，这里修改的是808端口，默认是8080</p>
</blockquote>
<h3 id="启动skywalking的方法是："><a href="#启动skywalking的方法是：" class="headerlink" title="启动skywalking的方法是："></a>启动skywalking的方法是：</h3><p>a.在解压下的bin目录，windows双击startup.bat，linux运行startup.sh</p>
<p>b.启动后检查端口 </p>
<h2 id="探针的配置"><a href="#探针的配置" class="headerlink" title="探针的配置"></a>探针的配置</h2><p>使用探针<br>在要监控的项目中使用探针，在开发环境，结合idea使用时，配置我们项目的启动参数：<br><figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-javaagent:D:<span class="symbol">\c</span>loud<span class="symbol">\a</span>pache-skywalking-apm-bin<span class="symbol">\a</span>gent<span class="symbol">\s</span>kywalking-agent.jar</span><br></pre></td></tr></table></figure></p>
<p>-javaagent后面时skywalking探针的绝对地址，也就是之前下载的skywalking的压缩包解压出来后目录下的agent目录下的skywalking-agent.jar包。</p>
<p>IDEA中使用 VM options中加入相同配置.<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">-javaagent:D:/apache-skywalking-apm-bin/agent/skywalking-agent.jar</span><br><span class="line">-Dskywalking.collector.<span class="attribute">backend_service</span>=localhost:12800</span><br><span class="line"></span><br><span class="line">agent（实际地址）</span><br><span class="line">IP 记得改 </span><br><span class="line"></span><br><span class="line">eg: </span><br><span class="line"></span><br><span class="line">-javaagent:E:/微服务/skywalking/apache-skywalking-apm-bin-es7/agent/skywalking-agent.jar</span><br><span class="line">-Dskywalking.collector.<span class="attribute">backend_service</span>=172.16.129.139:12800</span><br></pre></td></tr></table></figure></p>
<h2 id="配置优先级"><a href="#配置优先级" class="headerlink" title="配置优先级"></a>配置优先级</h2><p>skywalking agent配置覆盖<br>在正式环境使用探针时，每使用一次，都去配置一下agent的参数信息也是比较繁琐的，所以skywalking有配置覆盖的选项，即不同的形式的配置优先级是不一样的，具体如下：</p>
<blockquote>
<p>JVM配置 &gt; 系统环境变量 &gt; agent.config</p>
</blockquote>
<p>上面所用的方式是agent.config的方式，优先级是最低的，所以还可以覆盖他的配置：<br>jvm配置：<br><figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-javaagent:/path/to/skywalking-agent.jar=<span class="string">[option1]</span>=<span class="string">[value1]</span>,<span class="string">[option2]</span>=<span class="string">[value2]</span></span><br><span class="line">-javaagent:skywalkingagent.jar=agent.service_name=test,collector.backend_service=xxx:<span class="number">11800</span></span><br></pre></td></tr></table></figure></p>
<p>环境变量配置：<br><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">-Dskywalking.[option1]</span>=[value1]</span><br><span class="line"><span class="attr">-Dskywalking.service_name</span>=xxxx</span><br></pre></td></tr></table></figure></p>
<p>这样在启动的时候，就不用每次去复制一份agent文件了，只需要在启动时加上参数即可</p>
<h2 id="skywalking修改数据源"><a href="#skywalking修改数据源" class="headerlink" title="skywalking修改数据源"></a>skywalking修改数据源</h2><p> skywalking 版本 8.0， 对应使用mysql8.0,所以复制相应驱动至 skywalking\oap-libs<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">mysql-connector-java-8</span><span class="selector-class">.0</span><span class="selector-class">.21</span><span class="selector-class">.jar</span></span><br></pre></td></tr></table></figure></p>

        
    </section>
</article>


    <article class="article" itemscope itemprop="blogPost">
    
    <header class="article-header">
        
        <h1 itemprop="name">
            <a href="/2019/12/02/SpringCloud 进阶之 Ribbon 和 Feign 实现服务调用负载均衡/">SpringCloud进阶之Ribbon和Feign(负载均衡)</a>
        </h1>
        
        <div class="article-meta clearfix">
            <a class="article-date" href="https://wxzhongwang.github.io/categories/SpringCloud/index.html">
    
    <i class="icon-calendar"></i>
    
    <time datetime="2019-12-02T04:30:00.000Z" itemprop="datePublished">2019-12-02</time>
</a>

            
<div class="article-tag-list">
    <i class="icon-tag"></i>
    <a class="article-tag-link" href="/tags/SpringCloud/">SpringCloud</a>
</div>


        </div>
    </header>
    
    <section class="article-body markdown-body">
        
        <h1 id="Spring-Cloud-进阶之Ribbon和Feign-负载均衡"><a href="#Spring-Cloud-进阶之Ribbon和Feign-负载均衡" class="headerlink" title="Spring Cloud 进阶之Ribbon和Feign(负载均衡)"></a>Spring Cloud 进阶之Ribbon和Feign(负载均衡)</h1><h2 id="Ribbon-负载均衡"><a href="#Ribbon-负载均衡" class="headerlink" title="Ribbon 负载均衡"></a>Ribbon 负载均衡</h2><p>Spring Cloud Ribbon是基于Netflix Ribbon实现的一套客户端,负载均衡的工具;</p>
<h3 id="Ribbon-核心组件IRule"><a href="#Ribbon-核心组件IRule" class="headerlink" title="Ribbon 核心组件IRule"></a>Ribbon 核心组件IRule</h3><p>根据特定算法,从服务列表中选取一个要访问的服务:</p>
<ul>
<li>RoundRobinRule:轮询</li>
<li>RandomRule:随机</li>
<li>AvailabilityFilteringRule: 会先过滤掉由于多次访问故障而处于断路器跳闸状态的服务,以及并发的连接数量<br>超过阈值的服务,然后对剩余的服务列表按照轮询策略进行访问;</li>
<li>WeightedResponseTimeRule: 根据平均响应时间计算所有服务的权重,响应时间越快,服务权重越大,被选中的机率越高;<br>刚启动时,如果统计信息不足,则使用RoundRobinRule策略,等统计信息足够时,会切换到WeightedResponseTimeRule</li>
<li>RetryRule: 先按照RoundRobinRule的策略获取服务,如果获取服务失败,则在指定时间内会进行重试,获取可用的服务;</li>
<li>BestAvailableRule: 会先过滤掉由于多次访问故障而处于断路器跳闸状态的服务,然后选择一个并发量最小的服务;</li>
<li>ZoneAvoidanceRule: 默认规则,复合判断server所在区域的性能和server的可用性选择服务器;</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ConfigBean 添加新注解 @LoadBalanced, 用于加入 Ribbon 配置</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConfigBean</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@LoadBalanced</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RestTemplate <span class="title">getRestTemplate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RestTemplate();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConfigBean</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@LoadBalanced</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RestTemplate <span class="title">getRestTemplate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RestTemplate();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> IRule <span class="title">myRule</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RoundRobinRule(); <span class="comment">// 显式的指定使用轮询算法</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 修改主启动类</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="meta">@RibbonClient</span>(name=<span class="string">"MICROSERVICECLOUD-DEPT"</span>, configuration=MySelfRule.class)  <span class="comment">// 自定义Ribbon配置类</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DeptConsumer80_App</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        SpringApplication.run(DeptConsumer80_App.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// com.noodles.myrule</span></span><br><span class="line"><span class="comment">// 自定义Robbin规则类</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MySelfRule</span></span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> IRule <span class="title">myRule</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RandomRule(); <span class="comment">//自定义均衡策略</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Feign-负载均衡"><a href="#Feign-负载均衡" class="headerlink" title="Feign 负载均衡"></a>Feign 负载均衡</h2><p>Feign 是一个声明式WebService客户端:<br>使用方法: 定义一个接口,然后在上面添加注解;</p>
<ul>
<li>首先通过 @EnableFeignClients 注解开启 FeignClient 的功能。只有这个注解存在，才会在程序启动时开启 @FeignClient 注解的包扫描。</li>
<li>根据Feign的规则实现接口，并在接口上面加上 @FeignClient 注解。</li>
<li>程序启动后，会进行包扫描，扫描所有的@FeignClient 的注解的类，并将这些信息注入 IOC容器中。</li>
<li>当接口的方法被调用时，通过JDK的代理来生成具体的 RequestTemplate 模板对象。</li>
<li>根据 RequestTemplate 再生成 Http 请求的 Request 对象。</li>
<li>Request 对象交给 Client 去处理，其中 Client 的网络请求框架可以是 HTTPURLConnection、HttpClient 和 OkHttp。</li>
<li>最后Client被封装到LoadBalanceClient类，这个类结合类 Ribbon 做到了负载均衡。</li>
</ul>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 新建DeptClientService接口,并新增注解@FeignClient，来指定调用哪个服务</span></span><br><span class="line">   <span class="meta">@FeignClient(value=<span class="meta-string">"MICROSERVICECLOUD-DEPT"</span>)</span></span><br><span class="line">   <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">DeptClientService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">       <span class="meta">@RequestMapping(value=<span class="meta-string">"/dept/get/&#123;id&#125;"</span>, method= RequestMethod.GET)</span></span><br><span class="line">       <span class="keyword">public</span> Dept <span class="keyword">get</span>(<span class="meta">@PathVariable(<span class="meta-string">"id"</span>)</span> long id);</span><br><span class="line"></span><br><span class="line">       <span class="meta">@RequestMapping(value=<span class="meta-string">"/dept/list"</span>, method= RequestMethod.GET)</span></span><br><span class="line">       <span class="keyword">public</span> List&lt;Dept&gt; list();</span><br><span class="line"></span><br><span class="line">       <span class="meta">@RequestMapping(value=<span class="meta-string">"/dept/add"</span>, method= RequestMethod.POST)</span></span><br><span class="line">       <span class="keyword">public</span> boolean add(Dept dept);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// microservice-consumer-dept-feign 工程修改Controller</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DeptController_Consumer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//用于服务调用</span></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> DeptClientService service;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@RequestMapping(value=<span class="meta-string">"/consumer/dept/get/&#123;id&#125;"</span>)</span></span><br><span class="line">	<span class="keyword">public</span> Dept <span class="keyword">get</span>(<span class="meta">@PathVariable(<span class="meta-string">"id"</span>)</span> <span class="built_in">Long</span> id) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.service.<span class="keyword">get</span>(id);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@RequestMapping(value=<span class="meta-string">"/consumer/dept/list"</span>)</span></span><br><span class="line">	<span class="keyword">public</span> List&lt;Dept&gt; list()&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.service.list();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@RequestMapping(value=<span class="meta-string">"/consumer/dept/add"</span>)</span></span><br><span class="line">	<span class="keyword">public</span> Object add(Dept dept) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.service.add(dept);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

        
    </section>
</article>


    <article class="article" itemscope itemprop="blogPost">
    
    <header class="article-header">
        
        <h1 itemprop="name">
            <a href="/2019/12/02/Eureka 服务注册与发现/">Eureka服务注册与发现</a>
        </h1>
        
        <div class="article-meta clearfix">
            <a class="article-date" href="https://wxzhongwang.github.io/categories/SpringCloud/index.html">
    
    <i class="icon-calendar"></i>
    
    <time datetime="2019-12-02T04:30:00.000Z" itemprop="datePublished">2019-12-02</time>
</a>

            
<div class="article-tag-list">
    <i class="icon-tag"></i>
    <a class="article-tag-link" href="/tags/SpringCloud/">SpringCloud</a>
</div>


        </div>
    </header>
    
    <section class="article-body markdown-body">
        
        <h2 id="Eureka服务注册与发现"><a href="#Eureka服务注册与发现" class="headerlink" title="Eureka服务注册与发现"></a>Eureka服务注册与发现</h2><h3 id="概念原理"><a href="#概念原理" class="headerlink" title="概念原理"></a>概念原理</h3><p>过去，每个应用都是一个CPU，一个主机上的单一系统。然而今天，随着大数据和云计算时代的到来，任何独立的程序都可以运行在多个计算机上。并且随着业务的发展，访问用户量的增加，开发人员或小组的增加，<br>系统会被拆分成多个功能模块。拆分后每个功能模块可以作为一个独立的子系统提供其职责范围内的功能。而多个子系统中，由于职责不同并且会存在相互调用，同时可能每个子系统还需要多个实例部署在多台<br>服务器或者镜像中，导致了子系统间的相互调用形成了一个错综复杂的网状结构。</p>
<p>从单体演变成分布式架构。随着系统结构、架构的演变，系统功能的增加，用户量的增加，开发人员的增加等各种增加情况下，需要有一个比较好扩展的系统架构来快速、尽量减少代码改动的前提下以支持系统功能<br>的开发，用户量增加导致的硬件资源横向扩容，以及开发人员增加时的协同工作效率。在此基础上需要解决系统的稳定性、容错性、高并发的支持性等。以及随着系统功能的增加如何有效的管理系统，排查、<br>定位系统问题。同时当参与项目的人（包含测试、运维、业务等人员）越来越多时，如何能更高效的彼此之间协同办公的效率等等。所以微服务架构需要考虑的不仅仅是软件架构本身，需要从参与到整个项目实施<br>过程中的各个环节，可能的问题以及人员协同的整体情况去考虑。让整个项目做到可用（满足功能以及硬件资源的横向扩容）、可行（满足整个系统运行中的各个点的监控、排错等）、可持续（满足系统功能的可持续集成、<br>以及系统运行的可持续性）以及高效（系统运行的高效、人员协同工作的高效、功能迭代的高效等）。</p>
<h3 id="微服务通俗讲解"><a href="#微服务通俗讲解" class="headerlink" title="微服务通俗讲解"></a>微服务通俗讲解</h3><p>Spring Cloud提供了微服务解决的一整套方案，而Eureka是其重要组件，所以先要了解什么是“微服务”。</p>
<p>在大型系统架构中，会拆分多个子系统。这些系统往往都有这几个功能：提供接口，调用接口，以及该子系统自身的业务功能。这样的一个子系统就称为一个“微服务”。（可以理解为一个子系统的代码所实现的功能）</p>
<p>实例：<br>每个服务都会部署到多个机器（或镜像）中，这些多个部署的应用就是实例。（可以理解为一套子系统代码被部署到了多个机器上）</p>
<h4 id="Eureka的管理"><a href="#Eureka的管理" class="headerlink" title="Eureka的管理"></a>Eureka的管理</h4><p>基于以上概念，使用Eureka管理时会具备几个特性：</p>
<ul>
<li>服务需要有一个统一的名称（或服务ID）并且是唯一标识，以便于接口调用时各个接口的区分。并且需要将其注册到Eureka Server中，其他服务调用该接口时，也是根据这个唯一标识来获取。</li>
<li>服务下有多个实例，每个实例也有一个自己的唯一实例ID。因为它们各自有自己的基础信息如：不同的IP。所以它们的信息也需要注册到Eureka Server中，其他服务调用它们的服务接口时，<br>可以查看到多个该服务的实例信息，根据负载策略提供某个实例的调用信息后，调用者根据信息直接调用该实例。</li>
</ul>
<h3 id="eureka如何管理服务调用"><a href="#eureka如何管理服务调用" class="headerlink" title="eureka如何管理服务调用"></a>eureka如何管理服务调用</h3><ul>
<li><p>在Eureka Client启动的时候，将自身的服务的信息发送到Eureka Server。然后进行2调用当前服务器节点中的其他服务信息，保存到Eureka Client中。当服务间相互调用其它服务时，在Eureka Client中<br>获取服务信息（如服务地址，端口等）后，进行第3步，根据信息直接调用服务。（注：服务的调用通过http(s)调用）</p>
</li>
<li><p>当某个服务仅需要调用其他服务，自身不提供服务调用时。在Eureka Client启动后会拉取Eureka Server的其他服务信息，需要调用时，在Eureka Client的本地缓存中获取信息，调用服务。</p>
</li>
<li><p>Eureka Client通过向Eureka Serve发送心跳（默认每30秒）来续约服务的。 如果客户端持续不能续约，那么，它将在大约90秒内从服务器注册表中删除。 注册信息和续订被复制到集群中的Eureka Serve所有节点。 以此来确保当前服务还“活着”，可以被调用。</p>
</li>
<li><p>来自任何区域的Eureka Client都可以查找注册表信息（每30秒发生一次），以此来确保调用到的服务是“活的”。并且当某个服务被更新或者新加进来，也可以调用到新的服务。</p>
</li>
</ul>
<h3 id="Eureka-Server："><a href="#Eureka-Server：" class="headerlink" title="Eureka Server："></a>Eureka Server：</h3><ul>
<li><p>提供服务注册：各个微服务启动时，会通过Eureka Client向Eureka Server进行注册自己的信息（例如服务信息和网络信息），Eureka Server会存储该服务的信息。</p>
</li>
<li><p>提供服务信息提供：服务消费者在调用服务时，本地Eureka Client没有的情况下，会到Eureka Server拉取信息。</p>
</li>
<li><p>提供服务管理：通过Eureka Client的Cancel、心跳监控、renew等方式来维护该服务提供的信息以确保该服务可用以及服务的更新。</p>
</li>
<li><p>信息同步：每个Eureka Server同时也是Eureka Client，多个Eureka Server之间通过P2P复制的方式完成服务注册表的同步。同步时，被同步信息不会同步出去。也就是说有3个Eureka Server，Server1有新的服务信息时，同步到Server2后，Server2和Server3同步时，Server2不会把从Server1那里同步到的信息同步给Server3，只能由Server1自己同步给Server3。</p>
</li>
<li><p>每个可用区有一个Eureka集群，并且每个可用区至少有一个eureka服务器来处理区内故障。为了实现高可用，一般一个可用区中由三个Eureka Server组成。</p>
</li>
</ul>
<h3 id="Eureka-Client："><a href="#Eureka-Client：" class="headerlink" title="Eureka Client："></a>Eureka Client：</h3><ul>
<li><p>Eureka Client是一个Java客户端，用于简化与Eureka Server的交互。并且管理当前微服务，同时为当前的微服务提供服务提供者信息。</p>
</li>
<li><p>Eureka Client会拉取、更新和缓存Eureka Server中的信息。即使所有的Eureka Server节点都宕掉，服务消费者依然可以使用缓存中的信息找到服务提供者。</p>
</li>
<li><p>Eureka Client在微服务启动后，会周期性地向Eureka Server发送心跳（默认周期为30秒）以续约自己的信息。如果Eureka Server在一定时间内没有接收到某个微服务节点的心跳，Eureka Server将会注销该微服务节点（默认90秒）。</p>
</li>
<li><p>Eureka Client包含服务提供者Applicaton Service和服务消费者Application Client</p>
</li>
<li><p>Applicaton Service：服务提供者，提供服务给别个调用。</p>
</li>
<li><p>Application Client：服务消费者，调用别个提供的服务。</p>
</li>
<li><p>往往大多数服务本身既是服务提供者，也是服务消费者。</p>
</li>
</ul>
<h3 id="动作"><a href="#动作" class="headerlink" title="动作"></a>动作</h3><h4 id="Register：服务注册"><a href="#Register：服务注册" class="headerlink" title="Register：服务注册"></a>Register：服务注册</h4><p>当Eureka客户端向Eureka Server注册时，它提供自身的元数据，比如IP地址、端口，运行状况指示符URL，主页等。</p>
<h4 id="Renew：服务续约"><a href="#Renew：服务续约" class="headerlink" title="Renew：服务续约"></a>Renew：服务续约</h4><p>Eureka Client会每隔30秒发送一次心跳来续约。 通过续约来告知Eureka Server该Eureka客户仍然存在，没有出现问题。 正常情况下，如果Eureka Server在90秒没有收到Eureka客户的续约，它会将实例从其注册表中删除。 建议不要更改续约间隔。</p>
<h4 id="Fetch-Registries：获取注册列表信息"><a href="#Fetch-Registries：获取注册列表信息" class="headerlink" title="Fetch Registries：获取注册列表信息"></a>Fetch Registries：获取注册列表信息</h4><p>Eureka客户端从服务器获取注册表信息，并将其缓存在本地。客户端会使用该信息查找其他服务，从而进行远程调用。该注册列表信息定期（每30秒钟）更新一次。每次返回注册列表信息可能与Eureka客户端的缓存信息不同， Eureka客户端自动处理。如果由于某种原因导致注册列表信息不能及时匹配，Eureka客户端则会重新获取整个注册表信息。 Eureka服务器缓存注册列表信息，整个注册表以及每个应用程序的信息进行了压缩，压缩内容和没有压缩的内容完全相同。Eureka客户端和Eureka 服务器可以使用JSON / XML格式进行通讯。在默认的情况下Eureka客户端使用压缩JSON格式来获取注册列表的信息。</p>
<h4 id="Cancel：服务下线"><a href="#Cancel：服务下线" class="headerlink" title="Cancel：服务下线"></a>Cancel：服务下线</h4><p>Eureka客户端在程序关闭时向Eureka服务器发送取消请求。 发送请求后，该客户端实例信息将从服务器的实例注册表中删除。该下线请求不会自动完成，它需要调用以下内容：</p>
<p>DiscoveryManager.getInstance().shutdownComponent()；</p>
<h5 id="Eviction：服务剔除"><a href="#Eviction：服务剔除" class="headerlink" title="Eviction：服务剔除"></a>Eviction：服务剔除</h5><p>在默认的情况下，当Eureka客户端连续90秒没有向Eureka服务器发送服务续约，即心跳，Eureka服务器会将该服务实例从服务注册列表删除，即服务剔除。</p>

        
    </section>
</article>


    <article class="article" itemscope itemprop="blogPost">
    
    <header class="article-header">
        
        <h1 itemprop="name">
            <a href="/2019/12/02/Spring Cloud Config配置中心/">SpringCloud Config配置中心</a>
        </h1>
        
        <div class="article-meta clearfix">
            <a class="article-date" href="https://wxzhongwang.github.io/categories/SpringCloud/index.html">
    
    <i class="icon-calendar"></i>
    
    <time datetime="2019-12-02T04:30:00.000Z" itemprop="datePublished">2019-12-02</time>
</a>

            
<div class="article-tag-list">
    <i class="icon-tag"></i>
    <a class="article-tag-link" href="/tags/SpringCloud/">SpringCloud</a>
</div>


        </div>
    </header>
    
    <section class="article-body markdown-body">
        
        <h1 id="SpringCloud-Config配置中心"><a href="#SpringCloud-Config配置中心" class="headerlink" title="SpringCloud Config配置中心"></a>SpringCloud Config配置中心</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>在分布式系统中，由于服务数量巨多，为了方便服务配置文件统一管理，实时更新，所以需要分布式配置中心组件。在Spring Cloud中，有分布式配置中心组件spring cloud config ，<br>它支持配置服务放在配置服务的内存中（即本地），也支持放在远程Git仓库中。在spring cloud config 组件中，分两个角色，一是Config-Server，二是Config-Client。</p>
<h2 id="Config-Server从本地读取配置文件"><a href="#Config-Server从本地读取配置文件" class="headerlink" title="Config Server从本地读取配置文件"></a>Config Server从本地读取配置文件</h2><p>创建一个spring-boot项目，取名为 config-server，依赖如下：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-config-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>注解 @EnableConfigServer 开启配置服务器<br><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@SpringBootApplication</span></span><br><span class="line"><span class="variable">@EnableConfigServer</span> <span class="comment">//开启配置服务器</span></span><br><span class="line">public class ConfigServerApplication &#123;</span><br><span class="line"> </span><br><span class="line">    <span class="selector-tag">public</span> <span class="selector-tag">static</span> <span class="selector-tag">void</span> <span class="selector-tag">main</span>(String[] args) &#123;</span><br><span class="line">        <span class="selector-tag">SpringApplication</span><span class="selector-class">.run</span>(ConfigServerApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>需要在程序的配置文件application.properties文件配置以下。通过 spring.profile.active=native 来配置 ConfigServer 从本地读取配置，读取的路径为 classpath 下的 shared 目录。</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">server</span>:</span><br><span class="line">	<span class="attribute">port</span>: <span class="number">8769</span></span><br><span class="line"><span class="attribute">spring</span>:</span><br><span class="line">	<span class="attribute">application</span>:</span><br><span class="line">		<span class="attribute">name</span>: config-server</span><br><span class="line">	<span class="attribute">profiles</span>:</span><br><span class="line">		<span class="attribute">active</span>: native</span><br><span class="line">	<span class="attribute">cloud</span>:</span><br><span class="line">		<span class="attribute">config</span>:</span><br><span class="line">			<span class="attribute">server</span>:</span><br><span class="line">				<span class="attribute">native</span>:</span><br><span class="line">					<span class="attribute">search-locations</span>: <span class="attribute">classpath</span>:/shared</span><br></pre></td></tr></table></figure>
<p>在 resources 目录下新建 shared 文件夹，在 shared 文件夹下新建 config-client-dev.yml 文件。<br><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">server:</span></span><br><span class="line"><span class="symbol">  port:</span> <span class="number">8762</span></span><br><span class="line">  </span><br><span class="line"><span class="symbol">foo:</span> foo version <span class="number">1</span></span><br></pre></td></tr></table></figure></p>
<p>启动 config-server 工程！</p>
<h2 id="构建Config-Client"><a href="#构建Config-Client" class="headerlink" title="构建Config-Client"></a>构建Config-Client</h2><p>创建一个spring-boot项目，取名为 config-client，依赖如下：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>在 resources 目录下新建 bootstrap.yml 文件，因为 bootstrap 相对于 application 具有优先的执行顺序。<br>变量{spring.application.name}和{spring.profiles.active}，两者以“-”相连，构成了向 Config Server 读取的配置文件名。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">	<span class="attr">application:</span></span><br><span class="line">		<span class="attr">name:</span> <span class="string">config-client</span></span><br><span class="line">	<span class="attr">cloud:</span></span><br><span class="line">		<span class="attr">config:</span></span><br><span class="line">			<span class="attr">uri:</span> <span class="attr">http://localhost:8769</span></span><br><span class="line">			<span class="attr">fail-fast:</span> <span class="literal">true</span> <span class="comment">#读取没有成功，执行快速失败</span></span><br><span class="line">	<span class="attr">profiles:</span></span><br><span class="line">		<span class="attr">active:</span> <span class="string">dev</span></span><br></pre></td></tr></table></figure>
<p>编写一个接口，测试读取配置文件的 foo 变量，并通过 API 接口返回.<br><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@SpringBootApplication</span></span><br><span class="line"><span class="variable">@RestController</span></span><br><span class="line">public class ConfigClientApplication &#123;</span><br><span class="line"> </span><br><span class="line">    <span class="selector-tag">public</span> <span class="selector-tag">static</span> <span class="selector-tag">void</span> <span class="selector-tag">main</span>(String[] args) &#123;</span><br><span class="line">        <span class="selector-tag">SpringApplication</span><span class="selector-class">.run</span>(ConfigClientApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    @<span class="selector-tag">Value</span>(<span class="string">"$&#123;foo&#125;"</span>)</span><br><span class="line">    <span class="selector-tag">String</span> <span class="selector-tag">foo</span>;</span><br><span class="line"> </span><br><span class="line">    @<span class="selector-tag">RequestMapping</span>(value = <span class="string">"/foo"</span>)</span><br><span class="line">    <span class="selector-tag">public</span> <span class="selector-tag">String</span> <span class="selector-tag">hi</span>()&#123;</span><br><span class="line">        <span class="selector-tag">return</span> <span class="selector-tag">foo</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>启动 config-client 工程，访问 <a href="http://localhost:8762/foo，显示" target="_blank" rel="noopener">http://localhost:8762/foo，显示</a></p>
<p>foo version 1</p>
<p>可见 config-client 成功向 config-server 工程读取了配置文件中 foo 变量的值。</p>
<h2 id="Config-Server从远程Git仓库读取配置文件"><a href="#Config-Server从远程Git仓库读取配置文件" class="headerlink" title="Config Server从远程Git仓库读取配置文件"></a>Config Server从远程Git仓库读取配置文件</h2><p>修改 config-server 的配置文件 application.yml，代码如下.<br><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">server</span>:</span><br><span class="line">	<span class="attribute">port</span>: <span class="number">8769</span></span><br><span class="line"><span class="attribute">spring</span>:</span><br><span class="line">	<span class="attribute">application</span>:</span><br><span class="line">		<span class="attribute">name</span>: config-server</span><br><span class="line">	<span class="attribute">cloud</span>:</span><br><span class="line">		<span class="attribute">config</span>:</span><br><span class="line">			<span class="attribute">label</span>: master</span><br><span class="line">			<span class="attribute">server</span>:</span><br><span class="line">				<span class="attribute">git</span>:</span><br><span class="line">					<span class="attribute">uri</span>: <span class="attribute">https</span>:<span class="comment">//github.com/forezp/SpringcloudConfig</span></span><br><span class="line">					<span class="attribute">search-paths</span>: respo</span><br><span class="line">					<span class="attribute">username</span>: miles02<span class="variable">@163</span>.com</span><br><span class="line">					<span class="attribute">password</span>:</span><br></pre></td></tr></table></figure></p>
<p>如果Git仓库为公开仓库，可以不填写用户名和密码，如果是私有仓库需要填写，本例子是公开仓库，放心使用。</p>
<table>
<thead>
<tr>
<th>配置</th>
<th>解释</th>
</tr>
</thead>
<tbody>
<tr>
<td>spring.cloud.config.server.git.uri</td>
<td>配置git仓库地址</td>
</tr>
<tr>
<td>spring.cloud.config.server.git.searchPaths</td>
<td>配置仓库路径</td>
</tr>
<tr>
<td>spring.cloud.config.label</td>
<td>配置仓库的分支</td>
</tr>
<tr>
<td>spring.cloud.config.server.git.username</td>
<td>访问git仓库的用户名</td>
</tr>
<tr>
<td>spring.cloud.config.server.git.password</td>
<td>访问git仓库的用户密码</td>
</tr>
</tbody>
</table>
<p>远程仓库 <a href="https://github.com/xxxx/SpringcloudConfig/" target="_blank" rel="noopener">https://github.com/xxxx/SpringcloudConfig/</a> 中有个文件config-client-dev.properties文件中有一个属性：</p>
<p>foo = foo version 2</p>
<p>但是没有规定 server.port 属性，所以会以默认 的 8080 启动，启动程序：访问<a href="http://localhost:8080/foo" target="_blank" rel="noopener">http://localhost:8080/foo</a></p>
<p>foo version 2</p>
<p>可见，config-server 从远程 Git 仓库读取了配置文件，config-client 从config-server 读取了配置文件.</p>
<h2 id="构建高可用的-Config-Server"><a href="#构建高可用的-Config-Server" class="headerlink" title="构建高可用的 Config Server"></a>构建高可用的 Config Server</h2><p>将配置中心 config-server 做成一个微服务，并且将其集群化，从而达到高可用。</p>
<p>config-client 在工程启动类上加上注解 @EnableEurekaClient，开启 EurekaClient的功能。</p>
<p>在配置文件 application.yml 加入相关配置，向 service-id 为 config-server 的配置服务读取配置文件.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  application:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">config-client</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    config:</span></span><br><span class="line"><span class="attr">      fail-fast:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">      discovery:</span></span><br><span class="line"><span class="attr">        enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">        service-id:</span> <span class="string">config-server</span></span><br><span class="line"><span class="attr">  profiles:</span></span><br><span class="line"><span class="attr">    active:</span> <span class="string">dev</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">8762</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line"><span class="attr">  client:</span></span><br><span class="line"><span class="attr">    service-url:</span></span><br><span class="line"><span class="attr">      defaultZone:</span> <span class="attr">http://localhost:8761/eureka/</span></span><br></pre></td></tr></table></figure>
<p>启动 config-server、config-client 工程，访问 <a href="http://localhost:8762/foo，浏览器显" target="_blank" rel="noopener">http://localhost:8762/foo，浏览器显</a>:</p>
<p>foo version 2</p>
<p>只需要启动多个 config-server 实例即可搭建高可用的 config-server。</p>

        
    </section>
</article>


    <article class="article" itemscope itemprop="blogPost">
    
    <header class="article-header">
        
        <h1 itemprop="name">
            <a href="/2018/12/02/总览/">SpringCloud总览</a>
        </h1>
        
        <div class="article-meta clearfix">
            <a class="article-date" href="https://wxzhongwang.github.io/categories/SpringCloud/index.html">
    
    <i class="icon-calendar"></i>
    
    <time datetime="2018-12-02T04:30:00.000Z" itemprop="datePublished">2018-12-02</time>
</a>

            
<div class="article-tag-list">
    <i class="icon-tag"></i>
    <a class="article-tag-link" href="/tags/SpringCloud/">SpringCloud</a>
</div>


        </div>
    </header>
    
    <section class="article-body markdown-body">
        
        <h2 id="总览"><a href="#总览" class="headerlink" title="总览"></a>总览</h2><p>Spring Cloud 为开发人员提供了快速构建分布式系统中一些常见模式的工具（例如配置管理、服务发现、断路器、智能路由、微代理、控制总线、一次性令牌、全局锁、leader选举、分布式session、集群状态）。<br>分布式系统的协调导致了样板模式, 使用 Spring Cloud 开发人员可以快速地支持实现这些模式的服务和应用程序。它们可以在任何分布式环境中很好地工作，包括开发人员自己的笔记本电脑，裸机数据中心，<br>以及Cloud Foundry等托管平台。</p>
<p>Spring Cloud专注于为典型用例提供良好的开箱即用体验，并为其他用户提供可扩展性机制。</p>
<h2 id="功能"><a href="#功能" class="headerlink" title="功能"></a>功能</h2><table>
<thead>
<tr>
<th>功能（english）</th>
<th>功能</th>
</tr>
</thead>
<tbody>
<tr>
<td>Distributed/versioned configuration</td>
<td>分布式/版本化配置</td>
</tr>
<tr>
<td>Service registration and discovery</td>
<td>服务注册和发现</td>
</tr>
<tr>
<td>Routing</td>
<td>智能路由</td>
</tr>
<tr>
<td>Service-to-service calls</td>
<td>service-to-service调用</td>
</tr>
<tr>
<td>Load balancing</td>
<td>负载均衡</td>
</tr>
<tr>
<td>Circuit Breakers</td>
<td>断路器</td>
</tr>
<tr>
<td>Global locks</td>
<td>全局锁</td>
</tr>
<tr>
<td>Leadership election and cluster state</td>
<td>leader选举和集群状态管理</td>
</tr>
<tr>
<td>Distributed messaging</td>
<td>分布式消息</td>
</tr>
</tbody>
</table>
<h2 id="主要项目"><a href="#主要项目" class="headerlink" title="主要项目"></a>主要项目</h2><table>
<thead>
<tr>
<th>项目名称</th>
<th>项目职能</th>
</tr>
</thead>
<tbody>
<tr>
<td>Spring Cloud Config</td>
<td>Spring Cloud提供的分布式配置中心，为外部配置提供了客户端和服务端的支持。</td>
</tr>
<tr>
<td>Spring Cloud Netflix</td>
<td>与各种NetflixOSS组件集成（Eureka，Hystrix，Zuul，Archaius等）。</td>
</tr>
<tr>
<td>Spring Cloud Bus</td>
<td>用于将服务和服务实例与分布式消息传递连接在一起的事件总线。用于跨群集传播状态更改（例如，配置更改事件）。</td>
</tr>
<tr>
<td>Spring Cloud Cloudfoundry</td>
<td>提供应用程序与 Pivotal Cloud Foundry 集成。提供服务发现实现，还可以轻松实现受SSO和OAuth2保护的资源。</td>
</tr>
<tr>
<td>Spring Cloud Open Service Broker</td>
<td>为构建实现 Open service broker API 的服务代理提供了一个起点。    </td>
</tr>
<tr>
<td>Spring Cloud Cluster</td>
<td>提供Leadership选举，如：Zookeeper, Redis, Hazelcast, Consul等常见状态模式的抽象和实现。</td>
</tr>
<tr>
<td>Spring Cloud Consul</td>
<td>封装了Consul操作，consul 是一个服务发现与配置工具，与Docker容器可以无缝集成。</td>
</tr>
<tr>
<td>Spring Cloud Security</td>
<td>基于Spring security的安全工具包，为你的应用程序添加安全控制。在Zuul代理中为负载平衡的OAuth2 rest客户端和身份验证头中继提供支持。</td>
</tr>
<tr>
<td>Spring Cloud Sleuth</td>
<td>Spring Cloud 提供的分布式链路跟踪组件，兼容zipkin、HTracer和基于日志的跟踪（ELK）</td>
</tr>
<tr>
<td>Spring Cloud Data Flow</td>
<td>大数据操作工具，作为Spring XD的替代产品，它是一个混合计算模型，结合了流数据与批量数据的处理方式。</td>
</tr>
<tr>
<td>Spring Cloud Stream</td>
<td>数据流操作开发包，封装了与Redis,Rabbit、Kafka等发送接收消息。</td>
</tr>
<tr>
<td>Spring Cloud CLI</td>
<td>基于 Spring Boot CLI，可以让你以命令行方式快速建立云组件。</td>
</tr>
<tr>
<td>Spring Cloud OpenFeign</td>
<td>一个http client客户端，致力于减少http client客户端构建的复杂性。</td>
</tr>
<tr>
<td>Spring Cloud Gateway</td>
<td>Spring Cloud 提供的网关服务组件</td>
</tr>
<tr>
<td>Spring Cloud Stream App Starters</td>
<td>Spring Cloud Stream App Starters是基于Spring Boot的Spring 集成应用程序，可提供与外部系统的集成。</td>
</tr>
<tr>
<td>Spring Cloud Task</td>
<td>提供云端计划任务管理、任务调度。</td>
</tr>
<tr>
<td>Spring Cloud Task App Starters</td>
<td>SpringCloud任务应用程序启动器是SpringBoot应用程序，它可以是任何进程，包括不会永远运行的Spring批处理作业，并且在有限的数据处理周期后结束/停止。</td>
</tr>
<tr>
<td>Spring Cloud Zookeeper</td>
<td>操作Zookeeper的工具包，用于使用zookeeper方式的服务发现和配置管理。</td>
</tr>
<tr>
<td>Spring Cloud AWS</td>
<td>提供与托管的AWS集成</td>
</tr>
<tr>
<td>Spring Cloud Connectors</td>
<td>便于云端应用程序在各种PaaS平台连接到后端，如：数据库和消息代理服务。</td>
</tr>
<tr>
<td>Spring Cloud Starters</td>
<td>Spring Boot式的启动项目，为Spring Cloud提供开箱即用的依赖管理。</td>
</tr>
<tr>
<td>Spring Cloud Contract</td>
<td>Spring Cloud Contract是一个总体项目，其中包含帮助用户成功实施消费者驱动合同方法的解决方案。</td>
</tr>
<tr>
<td>Spring Cloud Pipelines</td>
<td>Spring Cloud Pipelines提供了一个固定意见的部署管道，其中包含确保您的应用程序可以零停机方式部署并轻松回滚出错的步骤。</td>
</tr>
<tr>
<td>Spring Cloud Function</td>
<td>Spring Cloud Function通过函数促进业务逻辑的实现。 它支持Serverless 提供商之间的统一编程模型，以及独立运行（本地或PaaS）的能力。</td>
</tr>
</tbody>
</table>
<h2 id="SpringCloud-与-SpringBoot-版本兼容关系"><a href="#SpringCloud-与-SpringBoot-版本兼容关系" class="headerlink" title="SpringCloud 与 SpringBoot 版本兼容关系"></a>SpringCloud 与 SpringBoot 版本兼容关系</h2><table>
<thead>
<tr>
<th>Release Train</th>
<th>Boot Version</th>
</tr>
</thead>
<tbody>
<tr>
<td>Greenwich</td>
<td>2.1.x</td>
</tr>
<tr>
<td>Finchley</td>
<td>2.0.x</td>
</tr>
<tr>
<td>Edgware</td>
<td>1.5.x</td>
</tr>
<tr>
<td>Dalston</td>
<td>1.5.x</td>
</tr>
</tbody>
</table>
<h2 id="SpringCloud-与子工程版本关系"><a href="#SpringCloud-与子工程版本关系" class="headerlink" title="SpringCloud 与子工程版本关系"></a>SpringCloud 与子工程版本关系</h2><table>
<thead>
<tr>
<th>Component</th>
<th>Edgware.SR5</th>
<th>Finchley.SR2</th>
<th>Finchley.BUILD-SNAPSHOT</th>
</tr>
</thead>
<tbody>
<tr>
<td>spring-cloud-aws</td>
<td>1.2.3.RELEASE</td>
<td>2.0.1.RELEASE</td>
<td>2.0.1.BUILD-SNAPSHOT</td>
</tr>
<tr>
<td>spring-cloud-bus</td>
<td>1.3.3.RELEASE</td>
<td>2.0.0.RELEASE</td>
<td>2.0.1.BUILD-SNAPSHOT</td>
</tr>
<tr>
<td>spring-cloud-cli</td>
<td>1.4.1.RELEASE</td>
<td>2.0.0.RELEASE</td>
<td>2.0.1.BUILD-SNAPSHOT</td>
</tr>
<tr>
<td>spring-cloud-commons</td>
<td>1.3.5.RELEASE</td>
<td>2.0.2.RELEASE</td>
<td>2.0.2.BUILD-SNAPSHOT</td>
</tr>
<tr>
<td>spring-cloud-contract</td>
<td>1.2.6.RELEASE</td>
<td>2.0.2.RELEASE</td>
<td>2.0.2.BUILD-SNAPSHOT</td>
</tr>
<tr>
<td>spring-cloud-config</td>
<td>1.4.5.RELEASE</td>
<td>2.0.2.RELEASE</td>
<td>2.0.2.BUILD-SNAPSHOT</td>
</tr>
<tr>
<td>spring-cloud-netflix</td>
<td>1.4.6.RELEASE</td>
<td>2.0.2.RELEASE</td>
<td>2.0.2.BUILD-SNAPSHOT</td>
</tr>
<tr>
<td>spring-cloud-security</td>
<td>1.2.3.RELEASE</td>
<td>2.0.1.RELEASE</td>
<td>2.0.1.BUILD-SNAPSHOT</td>
</tr>
<tr>
<td>spring-cloud-cloudfoundry</td>
<td>1.1.2.RELEASE</td>
<td>2.0.1.RELEASE</td>
<td>2.0.1.BUILD-SNAPSHOT</td>
</tr>
<tr>
<td>spring-cloud-consul</td>
<td>1.3.5.RELEASE</td>
<td>2.0.1.RELEASE</td>
<td>2.0.2.BUILD-SNAPSHOT</td>
</tr>
<tr>
<td>spring-cloud-sleuth</td>
<td>1.3.5.RELEASE</td>
<td>2.0.2.RELEASE</td>
<td>2.0.2.BUILD-SNAPSHOT</td>
</tr>
<tr>
<td>spring-cloud-stream</td>
<td>Ditmars.SR4</td>
<td>Elmhurst.SR1</td>
<td>Elmhurst.BUILD-SNAPSHOT</td>
</tr>
<tr>
<td>spring-cloud-zookeeper</td>
<td>1.2.2.RELEASE</td>
<td>2.0.0.RELEASE</td>
<td>2.0.1.BUILD-SNAPSHOT</td>
</tr>
<tr>
<td>spring-boot</td>
<td>1.5.16.RELEASE</td>
<td>2.0.6.RELEASE</td>
<td>2.0.7.BUILD-SNAPSHOT</td>
</tr>
<tr>
<td>spring-cloud-task</td>
<td>1.2.3.RELEASE</td>
<td>2.0.0.RELEASE</td>
<td>2.0.1.BUILD-SNAPSHOT</td>
</tr>
<tr>
<td>spring-cloud-vault</td>
<td>1.1.2.RELEASE</td>
<td>2.0.2.RELEASE</td>
<td>2.0.2.BUILD-SNAPSHOT</td>
</tr>
<tr>
<td>spring-cloud-gateway</td>
<td>1.0.2.RELEASE</td>
<td>2.0.2.RELEASE</td>
<td>2.0.2.BUILD-SNAPSHOT</td>
</tr>
<tr>
<td>spring-cloud-openfeign</td>
<td></td>
<td>2.0.2.RELEASE</td>
<td>2.0.2.BUILD-SNAPSHOT</td>
</tr>
<tr>
<td>spring-cloud-function</td>
<td>1.0.1.RELEASE</td>
<td>1.0.0.RELEASE</td>
<td>1.0.1.BUILD-SNAPSHOT</td>
</tr>
</tbody>
</table>
<h2 id="兼容"><a href="#兼容" class="headerlink" title="兼容"></a>兼容</h2><ul>
<li><p>Finchley 构建并使用Spring Boot 2.0.x，与 Spring Boot 1.5.x 不兼容。</p>
</li>
<li><p>Dalston 和 Edgware 基于 Spring Boot 1.5.x 构建，不兼容 SpringBoot 2.0.x</p>
</li>
<li><p>Camden 版本迭代正式结束，Dalston 将于2018年12月结束使用，Edgware 将遵循 Spring Boot 1.5.x 的生命周期结束。</p>
</li>
<li><p>Camden 基于SpringBoot 1.4.x 构建，但是也会支持 1.5.x 版本</p>
</li>
<li><p>Brixton 和 Angel 迭代结束时间是2017年7月，Brixton 基于SpringBoot 1.3.x ，同时也支持 1.4.x 版本</p>
</li>
<li><p>Angel 基于 SpringBoot 1.2.x ,在某些方式不兼容 SpringBoot 1.3.x 。</p>
</li>
<li><p>Brixton 构建在SpringBoot 1.3.x ，不兼容 SpringBoot 1.2.x 。一些基于Angel的库和大多数应用程序可以在Brixton上正常运行，但如果OAuth2具备spring-cloud-security 1.0的特性，则需要在任何地方进行更改。x被使用(它们大多在1.3.0中被移到Spring Boot中)。</p>
</li>
</ul>

        
    </section>
</article>


    <article class="article" itemscope itemprop="blogPost">
    
    <header class="article-header">
        
        <h1 itemprop="name">
            <a href="/2018/12/02/集群版本Nacos/">集群Nacos</a>
        </h1>
        
        <div class="article-meta clearfix">
            <a class="article-date" href="https://wxzhongwang.github.io/categories/SpringCloud/index.html">
    
    <i class="icon-calendar"></i>
    
    <time datetime="2018-12-02T04:30:00.000Z" itemprop="datePublished">2018-12-02</time>
</a>

            
<div class="article-tag-list">
    <i class="icon-tag"></i>
    <a class="article-tag-link" href="/tags/SpringCloud/">SpringCloud</a>
</div>


        </div>
    </header>
    
    <section class="article-body markdown-body">
        
        <h1 id="集群Nacos"><a href="#集群Nacos" class="headerlink" title="集群Nacos"></a>集群Nacos</h1><h2 id="工作模式："><a href="#工作模式：" class="headerlink" title="工作模式："></a>工作模式：</h2><p>因此开源的时候推荐用户把所有服务列表放到一个vip下面，然后挂到一个域名下面</p>
<p><a href="http://ip1:port/openAPI" target="_blank" rel="noopener">http://ip1:port/openAPI</a> 直连ip模式，机器挂则需要修改ip才可以使用。</p>
<p><a href="http://VIP:port/openAPI" target="_blank" rel="noopener">http://VIP:port/openAPI</a> 挂载VIP模式，直连vip即可，下面挂server真实ip，可读性不好。</p>
<p><a href="http://nacos.com:port/openAPI" target="_blank" rel="noopener">http://nacos.com:port/openAPI</a> 域名 + VIP模式，可读性好，而且换ip方便，推荐模式</p>
<p><img src="https://cdn.nlark.com/yuque/0/2019/jpeg/338441/1561258986171-4ddec33c-a632-4ec3-bfff-7ef4ffc33fb9.jpeg" alt="工作模式"></p>
<h2 id="环境说明："><a href="#环境说明：" class="headerlink" title="环境说明："></a>环境说明：</h2><ol>
<li>64 bit OS Linux/Unix/Mac，推荐使用Linux系统。</li>
<li>64 bit JDK 1.8+；下载.配置。</li>
<li>Maven 3.2.x+；下载.配置。</li>
<li>3个或3个以上Nacos节点才能构成集群。</li>
</ol>
<h2 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h2><p>使用源码编译：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">unzip nacos-source.zip</span><br><span class="line">cd nacos/</span><br><span class="line">mvn -Prelease-nacos clean <span class="keyword">install</span> -U  </span><br><span class="line">cd nacos/distribution/target/nacos-<span class="keyword">server</span><span class="number">-1.3</span><span class="number">.0</span>/nacos/<span class="keyword">bin</span></span><br></pre></td></tr></table></figure></p>
<p>直接使用压缩包：<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">unzip nacos-server-<span class="number">1.3</span>.<span class="number">0</span>.zip</span><br><span class="line">or</span><br><span class="line">tar -xvf nacos-server-<span class="number">1.3</span>.<span class="number">0</span><span class="selector-class">.tar</span><span class="selector-class">.gz</span></span><br><span class="line"></span><br><span class="line">cd nacos/bin</span><br></pre></td></tr></table></figure></p>
<h2 id="配置集群配置文件"><a href="#配置集群配置文件" class="headerlink" title="配置集群配置文件"></a>配置集群配置文件</h2><p>在nacos的解压目录nacos/的conf目录下，有配置文件cluster.conf，请每行配置成ip:port。（请配置3个或3个以上节点）<br><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">ip1:</span><span class="number">8848</span></span><br><span class="line"><span class="symbol">ip2:</span><span class="number">8848</span></span><br><span class="line"><span class="symbol">ip3:</span><span class="number">8848</span></span><br></pre></td></tr></table></figure></p>
<h2 id="确定数据源"><a href="#确定数据源" class="headerlink" title="确定数据源"></a>确定数据源</h2><h3 id="使用内置数据源"><a href="#使用内置数据源" class="headerlink" title="使用内置数据源"></a>使用内置数据源</h3><p>无需进行任何配置</p>
<h3 id="使用外置数据源"><a href="#使用外置数据源" class="headerlink" title="使用外置数据源"></a>使用外置数据源</h3><p>生产使用建议至少主备模式，或者采用高可用数据库。</p>
<h2 id="初始化-MySQL-数据库"><a href="#初始化-MySQL-数据库" class="headerlink" title="初始化 MySQL 数据库"></a>初始化 MySQL 数据库</h2><p>在nacos的解压目录nacos/的conf目录下，存在sql文件 nacos-mysql.sql</p>
<h2 id="修改application-properties-配置"><a href="#修改application-properties-配置" class="headerlink" title="修改application.properties 配置"></a>修改application.properties 配置</h2><p>application.properties配置文件</p>
<h2 id="启动服务器"><a href="#启动服务器" class="headerlink" title="启动服务器"></a>启动服务器</h2><p>Linux/Unix/Mac<br>Stand-alone mode<br><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">sh </span>startup.<span class="keyword">sh </span>-m standalone</span><br></pre></td></tr></table></figure></p>
<p>集群模式 + 使用内置数据源<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh startup<span class="selector-class">.sh</span> -<span class="selector-tag">p</span> embedded</span><br></pre></td></tr></table></figure></p>
<p>集群模式 + 使用外置数据源<br><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">sh</span> startup.<span class="keyword">sh</span></span><br></pre></td></tr></table></figure></p>
<h2 id="服务注册发现-和-配置管理"><a href="#服务注册发现-和-配置管理" class="headerlink" title="服务注册发现 和 配置管理"></a>服务注册发现 和 配置管理</h2><p>服务注册<br><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -X PUT 'http://127.0.0.1:<span class="number">8848</span>/nacos/v1/ns/instance?serviceName=nacos.naming.serviceName&amp;ip=20.18.7.10&amp;port=<span class="number">8080</span>'</span><br></pre></td></tr></table></figure></p>
<p>服务发现<br><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -X GET 'http://127.0.0.1:<span class="number">8848</span>/nacos/v1/ns/instances?serviceName=nacos.naming.serviceName'</span><br></pre></td></tr></table></figure></p>
<p>发布配置<br><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">curl</span> -X POST <span class="string">"http://127.0.0.1:8848/nacos/v1/cs/configs?dataId=nacos.cfg.dataId&amp;group=test&amp;content=helloWorld"</span></span><br></pre></td></tr></table></figure></p>
<p>获取配置<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -X <span class="builtin-name">GET</span> <span class="string">"http://127.0.0.1:8848/nacos/v1/cs/configs?dataId=nacos.cfg.dataId&amp;group=test"</span></span><br></pre></td></tr></table></figure></p>
<h2 id="关闭服务器"><a href="#关闭服务器" class="headerlink" title="关闭服务器"></a>关闭服务器</h2><p>Linux/Unix/Mac<br><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">sh</span> shutdown.<span class="keyword">sh</span></span><br></pre></td></tr></table></figure></p>

        
    </section>
</article>


    <article class="article" itemscope itemprop="blogPost">
    
    <header class="article-header">
        
        <h1 itemprop="name">
            <a href="/2018/12/02/Sentinel quick start/">Sentinel快速入门</a>
        </h1>
        
        <div class="article-meta clearfix">
            <a class="article-date" href="https://wxzhongwang.github.io/categories/SpringCloud/index.html">
    
    <i class="icon-calendar"></i>
    
    <time datetime="2018-12-02T04:30:00.000Z" itemprop="datePublished">2018-12-02</time>
</a>

            
<div class="article-tag-list">
    <i class="icon-tag"></i>
    <a class="article-tag-link" href="/tags/SpringCloud/">SpringCloud</a>
</div>


        </div>
    </header>
    
    <section class="article-body markdown-body">
        
        <h1 id="Sentinel快速入门"><a href="#Sentinel快速入门" class="headerlink" title="Sentinel快速入门"></a>Sentinel快速入门</h1><p>如下的代码任然是侵入式的使用方式，也提供了<a href="https://github.com/alibaba/Sentinel/wiki/%E6%B3%A8%E8%A7%A3%E6%94%AF%E6%8C%81" target="_blank" rel="noopener">注解支持模块</a>。</p>
<p>应用使用 pom 工程，则在 pom.xml 文件中加入以下代码即可：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.csp<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sentinel-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.7.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>First Demo 代码：</p>
<figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> sentinel;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.csp.sentinel.Entry;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.csp.sentinel.SphU;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.csp.sentinel.slots.block.BlockException;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.csp.sentinel.slots.block.RuleConstant;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.csp.sentinel.slots.block.flow.FlowRule;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.csp.sentinel.slots.block.flow.FlowRuleManager;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> class SentinelDemo &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="keyword">String</span>[] args) &#123;</span><br><span class="line">		initFlowRules();</span><br><span class="line">		<span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">			Entry entry = <span class="keyword">null</span>;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				entry = SphU.entry(<span class="string">"HelloWorld"</span>);</span><br><span class="line">				<span class="comment">/* 您的业务逻辑 - 开始 */</span></span><br><span class="line">				System.out.<span class="built_in">println</span>(<span class="string">"hello world"</span>);</span><br><span class="line">				<span class="comment">/* 您的业务逻辑 - 结束 */</span></span><br><span class="line">			&#125; <span class="keyword">catch</span> (BlockException e1) &#123;</span><br><span class="line">				<span class="comment">/* 流控逻辑处理 - 开始 */</span></span><br><span class="line">				System.out.<span class="built_in">println</span>(<span class="string">"block!"</span>);</span><br><span class="line">				<span class="comment">/* 流控逻辑处理 - 结束 */</span></span><br><span class="line">			&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">				<span class="keyword">if</span> (entry != <span class="keyword">null</span>) &#123;</span><br><span class="line">					entry.<span class="built_in">exit</span>();</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 接下来，通过规则来指定允许该资源通过的请求次数</span></span><br><span class="line"><span class="comment">// 例如下面的代码定义了资源 HelloWorld 每秒最多只能通过 20 个请求。</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> initFlowRules() &#123;</span><br><span class="line">		List&lt;FlowRule&gt; rules = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">		FlowRule rule = <span class="keyword">new</span> FlowRule();</span><br><span class="line">		rule.setResource(<span class="string">"HelloWorld"</span>);</span><br><span class="line">		rule.setGrade(RuleConstant.FLOW_GRADE_QPS);</span><br><span class="line">		<span class="comment">// Set limit QPS to 20.</span></span><br><span class="line">		rule.setCount(<span class="number">20</span>);</span><br><span class="line">		rules.<span class="built_in">add</span>(rule);</span><br><span class="line">		FlowRuleManager.loadRules(rules);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Demo 运行之后，我们可以在日志里看到下面的输出:<br><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">window机器位于 C:\Users\shengwangzhong\logs\xxxx</span><br><span class="line">~/logs/csp/$&#123;appName&#125;-metrics.log.xxx</span><br><span class="line"></span><br><span class="line">输出：</span><br><span class="line">|<span class="type">--timestamp</span>-|<span class="type">------date</span> <span class="built_in">time</span>----|<span class="type">-resource</span>-|<span class="type">p</span> |<span class="type">block</span>|<span class="type">s</span> |<span class="type">e</span>|<span class="type">rt</span></span><br><span class="line"><span class="number">1529998904000</span>|<span class="type">2018</span><span class="number">-06</span><span class="number">-26</span> <span class="number">15</span>:<span class="number">41</span>:<span class="number">44</span>|<span class="type">HelloWorld</span>|<span class="type">20</span>|<span class="type">0</span>    |<span class="type">20</span>|<span class="type">0</span>|<span class="type">0</span></span><br><span class="line"><span class="number">1529998905000</span>|<span class="type">2018</span><span class="number">-06</span><span class="number">-26</span> <span class="number">15</span>:<span class="number">41</span>:<span class="number">45</span>|<span class="type">HelloWorld</span>|<span class="type">20</span>|<span class="type">5579</span> |<span class="type">20</span>|<span class="type">0</span>|<span class="type">728</span></span><br><span class="line"><span class="number">1529998906000</span>|<span class="type">2018</span><span class="number">-06</span><span class="number">-26</span> <span class="number">15</span>:<span class="number">41</span>:<span class="number">46</span>|<span class="type">HelloWorld</span>|<span class="type">20</span>|<span class="type">15698</span>|<span class="type">20</span>|<span class="type">0</span>|<span class="type">0</span></span><br><span class="line"><span class="number">1529998907000</span>|<span class="type">2018</span><span class="number">-06</span><span class="number">-26</span> <span class="number">15</span>:<span class="number">41</span>:<span class="number">47</span>|<span class="type">HelloWorld</span>|<span class="type">20</span>|<span class="type">19262</span>|<span class="type">20</span>|<span class="type">0</span>|<span class="type">0</span></span><br><span class="line"><span class="number">1529998908000</span>|<span class="type">2018</span><span class="number">-06</span><span class="number">-26</span> <span class="number">15</span>:<span class="number">41</span>:<span class="number">48</span>|<span class="type">HelloWorld</span>|<span class="type">20</span>|<span class="type">19502</span>|<span class="type">20</span>|<span class="type">0</span>|<span class="type">0</span></span><br><span class="line"><span class="number">1529998909000</span>|<span class="type">2018</span><span class="number">-06</span><span class="number">-26</span> <span class="number">15</span>:<span class="number">41</span>:<span class="number">49</span>|<span class="type">HelloWorld</span>|<span class="type">20</span>|<span class="type">18386</span>|<span class="type">20</span>|<span class="type">0</span>|<span class="type">0</span></span><br></pre></td></tr></table></figure></p>
<p>其中 p 代表通过的请求, block 代表被阻止的请求, s 代表成功执行完成的请求个数, e 代表用户自定义的异常, rt 代表平均响应时长。</p>
<p>结合控制台使用：</p>
<p>首先需要保证控制台处于启动状态：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -Dserver.<span class="attribute">port</span>=8080 -Dcsp.sentinel.dashboard.<span class="attribute">server</span>=localhost:8080 -Dproject.<span class="attribute">name</span>=sentinel-dashboard -jar sentinel-dashboard.jar</span><br></pre></td></tr></table></figure></p>
<p>其中 -Dserver.port=8080 用于指定 Sentinel 控制台端口为 8080</p>
<p>此外针对上面的应用需要添加依赖：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.csp<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sentinel-transport-simple-http<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.7.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>同时需要添加程序启动参数：<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-Dcsp<span class="selector-class">.sentinel</span><span class="selector-class">.dashboard</span><span class="selector-class">.server</span>=consoleIp:port</span><br><span class="line">                ↓↓↓↓↓↓↓</span><br><span class="line">-Dcsp<span class="selector-class">.sentinel</span><span class="selector-class">.dashboard</span><span class="selector-class">.server</span>=localhost:<span class="number">8080</span></span><br></pre></td></tr></table></figure></p>
<p>若启动多个应用，则需要通过 -Dcsp.sentinel.api.port=xxxx 指定客户端监控 API 的端口（默认是 8719）。</p>
<p>这时候，在启动程序以后，可以再dashboard页面能对具体的应用进行实时监控。</p>

        
    </section>
</article>


    <article class="article" itemscope itemprop="blogPost">
    
    <header class="article-header">
        
        <h1 itemprop="name">
            <a href="/2018/12/02/Sentinel 主流框架的适配/">Sentinel 主流框架的适配</a>
        </h1>
        
        <div class="article-meta clearfix">
            <a class="article-date" href="https://wxzhongwang.github.io/categories/SpringCloud/index.html">
    
    <i class="icon-calendar"></i>
    
    <time datetime="2018-12-02T04:30:00.000Z" itemprop="datePublished">2018-12-02</time>
</a>

            
<div class="article-tag-list">
    <i class="icon-tag"></i>
    <a class="article-tag-link" href="/tags/SpringCloud/">SpringCloud</a>
</div>


        </div>
    </header>
    
    <section class="article-body markdown-body">
        
        <h1 id="Sentinel-主流框架的适配"><a href="#Sentinel-主流框架的适配" class="headerlink" title="Sentinel 主流框架的适配"></a>Sentinel 主流框架的适配</h1><p><a href="https://github.com/alibaba/Sentinel/wiki/%E4%B8%BB%E6%B5%81%E6%A1%86%E6%9E%B6%E7%9A%84%E9%80%82%E9%85%8D" target="_blank" rel="noopener">适配</a></p>
<p>为了减少开发的复杂程度，Sentinel对大部分的主流框架，例如 Web Servlet、Dubbo、Spring Cloud、gRPC、Spring WebFlux、Reactor 等都做了适配。您只需要引入对应的依赖即可方便地整合 Sentinel。<br>包括以下配置：</p>
<h3 id="Web-适配"><a href="#Web-适配" class="headerlink" title="Web 适配"></a>Web 适配</h3><ul>
<li>Spring Boot/Spring Cloud</li>
<li>Web Servlet</li>
<li>Spring WebFlux<h3 id="RPC-适配"><a href="#RPC-适配" class="headerlink" title="RPC 适配"></a>RPC 适配</h3></li>
<li>Apache Dubbo</li>
<li>gRPC</li>
<li>Feign</li>
<li>SOFARPC<h3 id="HTTP-client-适配"><a href="#HTTP-client-适配" class="headerlink" title="HTTP client 适配"></a>HTTP client 适配</h3></li>
<li>Apache HttpClient</li>
<li>OkHttp</li>
<li>Reactive 适配</li>
<li>Reactor<h3 id="API-Gateway-适配"><a href="#API-Gateway-适配" class="headerlink" title="API Gateway 适配"></a>API Gateway 适配</h3></li>
<li>Spring Cloud Gateway</li>
<li>Netflix Zuul 1.x</li>
<li>Netflix Zuul 2.x</li>
<li>Apache RocketMQ</li>
</ul>

        
    </section>
</article>


    <article class="article" itemscope itemprop="blogPost">
    
    <header class="article-header">
        
        <h1 itemprop="name">
            <a href="/2018/12/02/Sentinel 注解式支持/">Sentinel 注解式支持</a>
        </h1>
        
        <div class="article-meta clearfix">
            <a class="article-date" href="https://wxzhongwang.github.io/categories/SpringCloud/index.html">
    
    <i class="icon-calendar"></i>
    
    <time datetime="2018-12-02T04:30:00.000Z" itemprop="datePublished">2018-12-02</time>
</a>

            
<div class="article-tag-list">
    <i class="icon-tag"></i>
    <a class="article-tag-link" href="/tags/SpringCloud/">SpringCloud</a>
</div>


        </div>
    </header>
    
    <section class="article-body markdown-body">
        
        <h1 id="Sentinel-注解式支持"><a href="#Sentinel-注解式支持" class="headerlink" title="Sentinel 注解式支持"></a>Sentinel 注解式支持</h1><p>@SentinelResource 用于定义资源，并提供可选的异常处理和 fallback 配置项。 @SentinelResource 注解包含以下属性：</p>
<ul>
<li>value：资源名称，必需项（不能为空）</li>
<li>entryType：entry 类型，可选项（默认为 EntryType.OUT）</li>
<li>blockHandler / blockHandlerClass</li>
</ul>
<p>blockHandler 对应处理 BlockException 的函数名称，可选项。blockHandler 函数访问范围需要是 public，返回类型需要与原方法相匹配，参数类型需要和原方法相匹配并且最后加一个额外的参数，类型为 BlockException。blockHandler 函数默认需要和原方法在同一个类中。若希望使用其他类的函数，则可以指定 blockHandlerClass 为对应的类的 Class 对象，注意对应的函数必需为 static 函数，否则无法解析。</p>
<ul>
<li>fallback / fallbackClass</li>
</ul>
<p>fallback 函数名称，可选项，用于在抛出异常的时候提供 fallback 处理逻辑。fallback 函数可以针对所有类型的异常（除了exceptionsToIgnore里面排除掉的异常类型）进行处理。<br>fallback 函数签名和位置要求：</p>
<ol>
<li>返回值类型必须与原函数返回值类型一致；</li>
<li>方法参数列表需要和原函数一致，或者可以额外多一个Throwable类型的参数用于接收对应的异常。</li>
<li>fallback 函数默认需要和原方法在同一个类中。若希望使用其他类的函数，则可以指定 fallbackClass 为对应的类的 Class 对象，注意对应的函数必需为 static 函数，否则无法解析。</li>
</ol>
<ul>
<li>defaultFallback（since 1.6.0）：</li>
</ul>
<p>默认的 fallback 函数名称，可选项，通常用于通用的 fallback 逻辑（即可以用于很多服务或方法）。默认 fallback 函数可以针对所有类型的异常（除了 exceptionsToIgnore 里面排除掉的异常类型）进行处理。若同时配置了 fallback 和 defaultFallback，则只有 fallback 会生效。</p>
<p>defaultFallback 函数签名要求：</p>
<ol>
<li>返回值类型必须与原函数返回值类型一致；</li>
<li>方法参数列表需要为空，或者可以额外多一个Throwable类型的参数用于接收对应的异常。</li>
<li>defaultFallback 函数默认需要和原方法在同一个类中。若希望使用其他类的函数，则可以指定 fallbackClass 为对应的类的 Class 对象，注意对应的函数必需为 static 函数，否则无法解析。</li>
</ol>
<ul>
<li>exceptionsToIgnore：用于指定哪些异常被排除掉，不会计入异常统计中，也不会进入 fallback 逻辑中，而是会原样抛出。</li>
</ul>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 对应的 `handleException` 函数需要位于 `ExceptionUtil` 类中，并且必须为 static 函数.</span></span><br><span class="line">    <span class="meta">@SentinelResource</span>(value = <span class="string">"test"</span>, blockHandler = <span class="string">"handleException"</span>, blockHandlerClass = &#123;ExceptionUtil.class&#125;)</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Test"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 原函数</span></span><br><span class="line">    <span class="meta">@SentinelResource</span>(value = <span class="string">"hello"</span>, blockHandler = <span class="string">"exceptionHandler"</span>, fallback = <span class="string">"helloFallback"</span>)</span><br><span class="line">    <span class="keyword">public</span> <span class="function">String <span class="title">hello</span><span class="params">(<span class="keyword">long</span> s)</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">return</span> String.<span class="title">format</span><span class="params">(<span class="string">"Hello at %d"</span>, s)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Fallback 函数，函数签名与原函数一致或加一个 Throwable 类型的参数.</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function">String <span class="title">helloFallback</span><span class="params">(<span class="keyword">long</span> s)</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">return</span> String.<span class="title">format</span><span class="params">(<span class="string">"Halooooo %d"</span>, s)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Block 异常处理函数，参数最后多一个 BlockException，其余与原函数一致.</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function">String <span class="title">exceptionHandler</span><span class="params">(<span class="keyword">long</span> s, BlockException ex)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Do some log here.</span></span><br><span class="line">        ex.printStackTrace();</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Oops, error occurred at "</span> + s;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
        
    </section>
</article>


    <article class="article" itemscope itemprop="blogPost">
    
    <header class="article-header">
        
        <h1 itemprop="name">
            <a href="/2018/12/02/单机版本Nacos/">nacos单机模式支持mysql</a>
        </h1>
        
        <div class="article-meta clearfix">
            <a class="article-date" href="https://wxzhongwang.github.io/categories/SpringCloud/index.html">
    
    <i class="icon-calendar"></i>
    
    <time datetime="2018-12-02T04:30:00.000Z" itemprop="datePublished">2018-12-02</time>
</a>

            
<div class="article-tag-list">
    <i class="icon-tag"></i>
    <a class="article-tag-link" href="/tags/SpringCloud/">SpringCloud</a>
</div>


        </div>
    </header>
    
    <section class="article-body markdown-body">
        
        <h1 id="单机模式支持mysql"><a href="#单机模式支持mysql" class="headerlink" title="单机模式支持mysql"></a>单机模式支持mysql</h1><p>在0.7版本之前，在单机模式时nacos使用嵌入式数据库实现数据的存储，不方便观察数据存储的基本情况。0.7版本增加了支持mysql数据源能力，具体的操作步骤：</p>
<ol>
<li>安装数据库，版本要求：5.6.5+</li>
<li>初始化mysql数据库，数据库初始化文件：nacos-mysql.sql</li>
<li>修改conf/application.properties文件，增加支持mysql数据源配置（目前只支持mysql），添加mysql数据源的url、用户名和密码。</li>
</ol>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring.datasource.platform</span>=mysql</span><br><span class="line"></span><br><span class="line"><span class="attr">db.num</span>=<span class="number">1</span></span><br><span class="line"><span class="attr">db.url.0</span>=jdbc:mysql://<span class="number">11.162</span>.<span class="number">196.16</span>:<span class="number">3306</span>/nacos_devtest?characterEncoding=utf8&amp;connectTimeout=<span class="number">1000</span>&amp;socketTimeout=<span class="number">3000</span>&amp;autoReconnect=<span class="literal">true</span></span><br><span class="line"><span class="attr">db.user</span>=nacos_devtest</span><br><span class="line"><span class="attr">db.password</span>=youdontknow</span><br></pre></td></tr></table></figure>
        
    </section>
</article>




<nav class="page-nav">
    <span class="page-number current">1</span><a class="page-number" href="/categories/SpringCloud/page/2/">2</a><a class="extend next" rel="next" href="/categories/SpringCloud/page/2/">下一页 &raquo;</a>
</nav>


</div>
        <footer class="footer">
    Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>, Theme by <a href="https://github.com/sanonz/hexo-theme-concise" target="_blank">Concise</a>

    
    <script>
        var _hmt = _hmt || [];
        (function () {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?e4027971a230b210f4671f485b33846a";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();
    </script>
    
</footer>

    </main>

    <script type="text/javascript" src="https://cdn.bootcss.com/jquery/1.9.0/jquery.min.js"></script>
    <script type="text/javascript">
    $(function() {
        var nodes = {
            nav: $('#nav'),
            aside: $('#aside'),
            asideInner: $('#aside-inner'),
            navInner: $('#nav-inner')
        };

        var doing = false;
        nodes.asideInner.on('webkitAnimationEnd mozAnimationEnd oAnimationEnd oanimationend animationend', function() {
            if (nodes.aside.hasClass('mobile-open')) {
                nodes.aside.removeClass('mobile-open');
            } else {
                nodes.aside.removeClass('mobile-close panel-show');
            }
            doing = false;
        });
        $('#open-panel, #aside-mask').on('click', function() {
            if (doing) {
                return;
            }
            
            if (nodes.aside.hasClass('panel-show')) {
                nodes.aside.addClass('mobile-close');
            } else {
                nodes.aside.addClass('mobile-open panel-show');
            }
        });
        $('#open-menus').on('click', function() {
            nodes.navInner.slideToggle();
        });

        if (window.innerWidth <= 960) {
            setTimeout(function() {
                nodes.navInner.slideUp();
            }, 3000);
        }
    });
    </script>
    

</body>
</html>
